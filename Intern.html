<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<link rel="icon" href="./assets/favicon.png">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Polizei Einstellungstest - Deutschland RP</title>
<style>
/* --- Basis CSS --- */
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 50%, #0f1419 100%);
  color: #fff;
  min-height: 100vh;
}

/* --- Login & Quiz Container --- */
.center-wrapper {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 20px;
}

.auth-card {
  background: linear-gradient(135deg, rgba(15, 32, 39, 0.95), rgba(44, 83, 100, 0.9));
  backdrop-filter: blur(10px);
  border-radius: 20px;
  padding: 40px;
  max-width: 600px;
  width: 100%;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
  border: 1px solid rgba(255, 215, 0, 0.3);
  text-align: center;
}

.logo { font-size: 50px; margin-bottom: 20px; }
.title { color: #ffd700; font-size: 28px; font-weight: 800; margin-bottom: 10px; }
.subtitle { color: #cbd5e0; margin-bottom: 30px; line-height: 1.6; }

/* Discord Button */
.btn-discord {
  background: #5865F2;
  color: white;
  padding: 15px 30px;
  border-radius: 8px;
  border: none;
  font-weight: 700;
  font-size: 16px;
  cursor: pointer;
  transition: all 0.3s;
  display: inline-flex;
  align-items: center;
  gap: 10px;
  text-decoration: none;
}
.btn-discord:hover { background: #4752c4; transform: translateY(-2px); }

/* Quiz Styles */
.quiz-container { text-align: left; display: none; }
.quiz-progress { color: #ffd700; font-size: 14px; margin-bottom: 15px; text-align: right; }
.question-text { font-size: 20px; font-weight: 600; margin-bottom: 25px; }
.options-grid { display: grid; gap: 15px; }

.option-btn {
  background: rgba(255, 255, 255, 0.1);
  border: 2px solid rgba(255, 255, 255, 0.1);
  padding: 15px;
  border-radius: 10px;
  color: white;
  text-align: left;
  cursor: pointer;
  transition: all 0.2s;
}
.option-btn:hover { background: rgba(255, 215, 0, 0.1); border-color: #ffd700; }
.option-btn.selected { background: #ffd700; color: #000; font-weight: bold; }

/* Dashboard Styles */
.dashboard { display: none; }
.header { background: rgba(0,0,0,0.7); border-bottom: 3px solid #ffd700; padding: 40px 0; text-align: center; }
.container { max-width: 1400px; margin: 0 auto; padding: 20px; }
.section-title { color: #ffd700; font-size: 24px; margin-bottom: 20px; border-bottom: 1px solid rgba(255,215,0,0.3); padding-bottom: 10px; }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 40px; }
.stat-card { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; text-align: center; border: 1px solid rgba(255,215,0,0.2); }
.stat-value { font-size: 30px; color: #ffd700; font-weight: bold; }

/* Fail Screen */
.fail-screen { display: none; color: #fca5a5; }
.fail-icon { font-size: 60px; margin-bottom: 20px; }

/* Utility */
.hidden { display: none !important; }
</style>
</head>
<body>

<div id="loginScreen" class="center-wrapper">
  <div class="auth-card">
    <div class="logo">üîí</div>
    <h1 class="title">Interner Bereich</h1>
    <p class="subtitle">
      Um Zugriff auf das Dienstportal zu erhalten, musst du dich mit Discord verifizieren und den Eignungstest bestehen.<br>
      <small>Hinweis: Der Test kann nur einmal pro Account durchgef√ºhrt werden.</small>
    </p>
    <button id="discordLoginBtn" class="btn-discord">
      <span>Mit Discord verbinden</span>
    </button>
  </div>
</div>

<div id="quizScreen" class="center-wrapper hidden">
  <div class="auth-card">
    <div class="quiz-container" style="display: block;">
      <div class="quiz-progress">Frage <span id="qCurrent">1</span> von <span id="qTotal">10</span></div>
      <div class="question-text" id="questionText">Lade Frage...</div>
      <div class="options-grid" id="optionsContainer"></div>
    </div>
  </div>
</div>

<div id="failScreen" class="center-wrapper hidden">
  <div class="auth-card" style="border-color: #ef4444;">
    <div class="fail-icon">‚ùå</div>
    <h1 class="title" style="color: #ef4444;">Durchgefallen</h1>
    <p class="subtitle">
      Du hast mehr als 8 Fehlerpunkte erreicht.<br>
      Gem√§√ü Dienstvorschrift wurde dein Zugriff verweigert.<br><br>
      Deine Ergebnisse wurden an die Ausbildungsleitung √ºbermittelt.
    </p>
  </div>
</div>

<div id="dashboardContent" class="dashboard">
  <header class="header">
    <div class="container">
      <h1 style="font-size: 40px; text-transform: uppercase;">Polizei</h1>
      <div style="color: #ffd700; font-weight: bold;">DEUTSCHLAND RP - INTERNER BEREICH</div>
    </div>
  </header>

  <main class="container">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-value" id="userDisplay">Gast</div>
        <div>Angemeldet</div>
      </div>
      <div class="stat-card">
        <div class="stat-value">‚úÖ</div>
        <div>Dienstvorschrift Bestanden</div>
      </div>
    </div>

    <section>
      <h2 class="section-title">Willkommen im Dienst</h2>
      <p style="color: #cbd5e0; margin-bottom: 20px;">Du hast den Test erfolgreich absolviert. Hier kannst du nun navigieren:</p>
      
      <div style="display: grid; gap: 10px; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
         <a href="Aktuelles.html" class="option-btn" style="text-align: center; text-decoration: none;">Aktuelles</a>
         <a href="Mitarbeiter.html" class="option-btn" style="text-align: center; text-decoration: none;">Mitarbeiter</a>
         <a href="Strafen.html" class="option-btn" style="text-align: center; text-decoration: none;">Bu√ügeldkatalog</a>
      </div>
      
      <br><br>
      <button onclick="logout()" style="background: #ef4444; border:none; color:white; padding:10px 20px; border-radius:5px; cursor:pointer;">Abmelden</button>
    </section>
  </main>
</div>

<script>
// ==========================================
// DEINE DATEN (Wurden eingef√ºgt)
// ==========================================
const CLIENT_ID = '1448720203113300161'; 
const WEBHOOK_URL = 'https://discord.com/api/webhooks/1448719996678045910/bZUNtO2H4G7q_iBrN1CLTuodu6kSlrW-RxCL9LqDbBO4v8wD7-XA-HjT_mLXpbYgZULH';

// Ermittelt automatisch die aktuelle URL (wichtig f√ºr den Redirect)
const REDIRECT_URI = window.location.href.split('#')[0]; 

// ==========================================
// FRAGEN KATALOG
// ==========================================
const questions = [
  { question: "Was ist die oberste Priorit√§t im Dienst?", options: ["Geld verdienen", "Schutz der Zivilisten und Wahrung der Gesetze", "Schnelle Autos fahren", "Kaffeepause"], correct: 1 },
  { question: "Wann darf die Schusswaffe eingesetzt werden?", options: ["Sofort bei Sichtkontakt", "Nur als allerletztes Mittel bei Lebensgefahr", "Wenn jemand beleidigend wird", "Bei Verkehrskontrollen"], correct: 1 },
  { question: "Wie verh√§ltst du dich bei einer allgemeinen Verkehrskontrolle?", options: ["Aggressiv und laut", "H√∂flich, bestimmt und Eigensicherung beachtend", "Ich ziehe den Fahrer sofort raus", "Ich ignoriere den Fahrer"], correct: 1 },
  { question: "Was bedeutet Status 5 im Funk?", options: ["Frage / Anliegen", "Pause", "Streife beendet", "Ben√∂tige Unterst√ºtzung"], correct: 0 },
  { question: "Darfst du als Polizist Straftaten begehen, um Verbrecher zu fangen?", options: ["Ja, der Zweck heiligt die Mittel", "Nein, Gesetze gelten auch f√ºr die Polizei", "Nur wenn niemand zuschaut", "Nur bei Bankraub"], correct: 1 },
  { question: "Was ist bei der Miranda-Warnung (Rechtebelehrung) zu beachten?", options: ["Muss nicht vorgelesen werden", "Muss zeitnah nach der Festnahme erfolgen", "Nur vor Gericht wichtig", "Kann man sich ausdenken"], correct: 1 },
  { question: "Wie viele Fehlerpunkte darfst du in diesem Test maximal haben?", options: ["10", "Keine", "7 (bei 8 fliegst du)", "20"], correct: 2 },
  { question: "Was tust du, wenn ein Rangh√∂herer einen Befehl gibt?", options: ["Diskutieren", "Ausf√ºhren, sofern nicht gesetzeswidrig", "Ignorieren", "Dienst beenden"], correct: 1 },
  { question: "Darfst du Dienstfahrzeuge privat nutzen?", options: ["Ja, immer", "Nein, streng verboten", "Nur am Wochenende", "Wenn ich tanke"], correct: 1 },
  { question: "Was ist Korruption?", options: ["Ein Kavaliersdelikt", "Strengstens verboten und f√ºhrt zum Ausschluss", "Erlaubt ab Rang 10", "Ein Brettspiel"], correct: 1 }
];

// ==========================================
// LOGIK
// ==========================================
let currentUser = null;
let currentQuestionIndex = 0;
let errorPoints = 0;

window.onload = () => {
  const fragment = new URLSearchParams(window.location.hash.slice(1));
  if (fragment.has('access_token')) {
    const accessToken = fragment.get('access_token');
    const tokenType = fragment.get('token_type');
    fetchDiscordUser(tokenType, accessToken);
  } else if (localStorage.getItem('police_user')) {
    const savedUser = JSON.parse(localStorage.getItem('police_user'));
    const status = localStorage.getItem('police_test_status');
    
    if (status === 'passed') {
      showDashboard(savedUser);
    } else if (status === 'failed') {
      showFailScreen();
    } else {
      startQuiz(savedUser);
    }
  }
};

document.getElementById('discordLoginBtn').addEventListener('click', () => {
  const scope = 'identify';
  const url = `https://discord.com/api/oauth2/authorize?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=${scope}`;
  window.location.href = url;
});

async function fetchDiscordUser(tokenType, accessToken) {
  try {
    const response = await fetch('https://discord.com/api/users/@me', {
      headers: { authorization: `${tokenType} ${accessToken}` }
    });
    const user = await response.json();
    
    if (localStorage.getItem(`quiz_done_${user.id}`)) {
       alert("Du hast diesen Test bereits absolviert!");
       if (localStorage.getItem('police_test_status') === 'failed') {
         showFailScreen();
       } else {
         showDashboard(user);
       }
       return;
    }
    currentUser = user;
    window.history.pushState("", document.title, window.location.pathname);
    startQuiz(user);

  } catch (error) {
    console.error(error);
    alert("Fehler beim Discord Login. Stelle sicher, dass die Redirect URI im Dev Portal stimmt!");
  }
}

function startQuiz(user) {
  currentUser = user;
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('quizScreen').classList.remove('hidden');
  showQuestion();
}

function showQuestion() {
  if (currentQuestionIndex >= questions.length) {
    finishQuiz();
    return;
  }
  const q = questions[currentQuestionIndex];
  document.getElementById('qCurrent').innerText = currentQuestionIndex + 1;
  document.getElementById('qTotal').innerText = questions.length;
  document.getElementById('questionText').innerText = q.question;

  const container = document.getElementById('optionsContainer');
  container.innerHTML = '';
  q.options.forEach((opt, index) => {
    const btn = document.createElement('div');
    btn.className = 'option-btn';
    btn.innerText = opt;
    btn.onclick = () => handleAnswer(index);
    container.appendChild(btn);
  });
}

function handleAnswer(selectedIndex) {
  const correctIndex = questions[currentQuestionIndex].correct;
  if (selectedIndex !== correctIndex) errorPoints++;
  currentQuestionIndex++;
  showQuestion();
}

function finishQuiz() {
  document.getElementById('quizScreen').classList.add('hidden');
  localStorage.setItem(`quiz_done_${currentUser.id}`, 'true');
  localStorage.setItem('police_user', JSON.stringify(currentUser));
  const passed = errorPoints < 8; 
  sendWebhook(passed);

  if (passed) {
    localStorage.setItem('police_test_status', 'passed');
    showDashboard(currentUser);
  } else {
    localStorage.setItem('police_test_status', 'failed');
    showFailScreen();
  }
}

function sendWebhook(passed) {
  const color = passed ? 5763719 : 15548997; 
  const statusText = passed ? "BESTANDEN ‚úÖ" : "DURCHGEFALLEN ‚ùå";
  const embed = {
    title: "üëÆ‚Äç‚ôÇÔ∏è Neuer Einstellungstest Absolviert",
    color: color,
    fields: [
      { name: "Bewerber", value: `${currentUser.username} (${currentUser.id})`, inline: true },
      { name: "Fehlerpunkte", value: `${errorPoints} von ${questions.length}`, inline: true },
      { name: "Ergebnis", value: statusText }
    ],
    thumbnail: { url: `https://cdn.discordapp.com/avatars/${currentUser.id}/${currentUser.avatar}.png` },
    footer: { text: "Polizei Dienstportal" },
    timestamp: new Date().toISOString()
  };

  fetch(WEBHOOK_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ embeds: [embed] })
  });
}

function showDashboard(user) {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('failScreen').classList.add('hidden');
  document.getElementById('dashboardContent').style.display = 'block';
  document.getElementById('userDisplay').innerText = user.username || user.global_name;
}

function showFailScreen() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('quizScreen').classList.add('hidden');
  document.getElementById('failScreen').classList.remove('hidden');
}

function logout() {
  localStorage.clear();
  window.location.href = window.location.pathname;
}
</script>
</body>
</html>
